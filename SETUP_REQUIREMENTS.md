# Setup Requirements for Website Opportunity Scanner

## What You Need to Provide

The scoring system is **already fully implemented** in the code. You just need to provide API keys to make it work.

### Required API Keys

#### 1. **Google API Key** (Required for Search + Website Scoring)
- **Purpose**: Analyzes website performance and generates the PageSpeed score (0-100)
- **How to get it**:
  1. Go to [Google Cloud Console](https://console.cloud.google.com/)
  2. Create a new project or select an existing one
  3. Enable:
     - "Places API" (for business search)
     - "PageSpeed Insights API" (for website scoring)
  4. Go to "Credentials" → "Create Credentials" → "API Key"
  5. Copy the API key
- **Add to `.env.local`**:
  ```
  GOOGLE_API_KEY=your_api_key_here
  ```
- **Note**: PageSpeed has a free tier (25,000 requests per day). For production use, you may need to enable billing.

#### 3. **Foursquare Places API Key** (Optional but Recommended)
- **Purpose**: Enriches business data with Foursquare ratings and popularity (used in scoring)
- **How to get it**:
  1. Go to [Foursquare Developer Portal](https://developer.foursquare.com/)
  2. Create an account and a new app
  3. Get your API key from the app dashboard
- **Add to `.env.local`**:
  ```
  FOURSQUARE_API_KEY=your_api_key_here
  ```
- **Note**: If not provided, the Foursquare score will be `null`, and the final score will only use PageSpeed.

## How the Scoring Works

The **Final Score** is calculated as:

```
Final Score = Median(PageSpeed Score, Foursquare Authority Score)
```

### Component Scores:

1. **PageSpeed Score (0-100)**
   - Generated by Google PageSpeed Insights API
   - Measures website performance, mobile-friendliness, and Core Web Vitals
   - Requires: `GOOGLE_API_KEY`

2. **Foursquare Authority Score (0-100)**
   - Calculated from Foursquare rating (0-10 scale) and popularity
   - Formula: `(rating / 10) * 70 + (popularity / 100) * 30`
   - Requires: `FOURSQUARE_API_KEY`

3. **Final Score (0-100)**
   - **Median** of the two component scores
   - If only one score is available, that score becomes the final score
   - If neither score is available, final score is `null`

### Score Interpretation:

- **0–30**: Actively hurting the business
- **31–60**: Website exists but weak
- **61–80**: Adequate but underperforming
- **81–100**: Strong presence, low priority

## What Happens Without API Keys?

- **Without `GOOGLE_API_KEY`**: 
  - PageSpeed score will be `null`
  - Final score will only use Foursquare score (if available)
  - If Foursquare is also missing, final score will be `null`

- **Without `FOURSQUARE_API_KEY`**:
  - Foursquare score will be `null`
  - Final score will only use PageSpeed score (if available)
  - If PageSpeed is also missing, final score will be `null`

- **Without both**:
  - Final score will be `null` for all businesses
  - You'll still see business information, but no opportunity scores

## Quick Setup Checklist

1. ✅ Create `.env.local` file in the project root
2. ✅ Add `GOOGLE_API_KEY` (required for search + analysis)
4. ✅ Add `FOURSQUARE_API_KEY` (optional, but recommended for complete scoring)
5. ✅ Restart your development server (`npm run dev`)

## Example `.env.local` File

```env
# Required
GOOGLE_API_KEY=AIzaSy...

# Optional (but recommended)
FOURSQUARE_API_KEY=fsq3...
```

## Testing Your Setup

After adding the API keys:

1. Search for a business (e.g., "dentist in Leeds")
2. Wait for auto-analysis to complete (or click "Analyze Website")
3. Check the score badge - you should see a number between 0-100
4. Click "Show Score Breakdown" to see PageSpeed and Foursquare scores

If scores are still `null`:
- Check your browser console for API errors
- Verify API keys are correct in `.env.local`
- Make sure billing is enabled for Google APIs
- Check API quotas/limits haven't been exceeded








## Two-tier payment model (Sitecheck)

### What we’re monetizing
This app has two real cost centers (external API calls):

- **Search** (`/api/search`)
  - Calls Google Places search + (per result) `getPlaceDetails`
  - One search can become **1 + N** paid Google requests depending on limit/results
- **Analysis** (`/api/analyse`)
  - Calls PageSpeed + HTML analysis + (optional) Foursquare refresh
  - Already has a cache behavior: returns a recent analysis within 7 days unless `force` is true

**Recommendation:** sell **analysis credits** (and optionally smaller “search credits”), because that aligns with cost and is easy to explain.

---

### Recommended 2-tier model: Free (credits) + Pro (subscription w/credits)
This gives predictable cost control (credits) and predictable revenue (subscription).

#### Free tier
- Includes **X analysis credits** (example: 20 total)
- Optionally include **Y searches/day** (example: 5/day) or **Z searches total** (example: 10 total)
- Limit batch actions:
  - Disable “Analyze all” or cap to small batches (e.g. 5 at a time)
- Optional feature limits:
  - CSV export capped (e.g. max 50 rows) or disabled on free

#### Pro tier (subscription)
- Monthly subscription includes **larger monthly credit allowance** (example: 1,000 analyses/month)
- Higher limits:
  - Unlimited searches (or a high cap)
  - Larger batch analyze + concurrency
  - Full CSV export
- Optional: credit rollover (e.g. 1 month rollover) to reduce churn

#### Optional: top-ups / overage
- Let Pro users buy extra credit packs (e.g. $10 for 500 credits), or hard-stop and prompt to upgrade.

---

### Credit charging rules (important)
Only deduct credits when we actually do paid work.

#### `/api/analyse`
- **Do NOT charge** if the API returns a cached analysis (within 7 days) and `force` is false
- **Do charge** if:
  - No recent cached analysis exists, or
  - User requested refresh (`force: true`)

#### `/api/search`
Because 1 search can trigger many requests, consider charging:
- **Per business imported/returned** (simplest cost alignment), OR
- **Per search** but tightly cap results, OR
- Free searches but charge only for analyses (simplest UX)

---

### Implementation plan (high level)
We’ll need **auth**, **billing**, and **enforcement**.

#### 1) Auth
Add user accounts so credits/subscriptions attach to a person/org.
Options: NextAuth, Clerk, Supabase Auth, etc.

#### 2) Billing
Use Stripe:
- Checkout for Pro subscription
- Billing portal for manage/cancel
- Webhooks to update subscription state and grant monthly credits

#### 3) Prisma data model additions (suggested)
Add tables like:
- `User`
- `Subscription`
  - stripeCustomerId, status, priceId, currentPeriodEnd
- `CreditBalance`
  - userId, balance
- `UsageEvent` (audit log)
  - userId, type: SEARCH|ANALYZE, quantity, createdAt, businessId?

#### 4) Enforcement points
Gate in:
- `app/api/search/route.ts`
- `app/api/analyse/route.ts`

Flow:
1. Identify user
2. Check subscription status / credit balance
3. Deduct credits **atomically** (Prisma transaction) *before* calling external APIs
4. If insufficient credits, return a clear upgrade response (e.g. 402/403 + message)

---

### Starter pricing (adjust after observing real usage)
Pick numbers that cover external API costs + margin.

Example:
- **Free**: 20 analysis credits + 5 searches/day
- **Pro**: $29/mo includes 1,000 analysis credits + unlimited searches + batch analyze + CSV export
- **Top-up** (optional): $10 for 500 credits

---

### Decision that affects everything
Are we building:
1) **Hosted SaaS (we pay for API keys/usage)** → credits are strongly recommended
2) **Bring-your-own-keys (customers supply keys)** → simpler subscription (fewer credit worries) can work better

We should decide this before implementing billing.
